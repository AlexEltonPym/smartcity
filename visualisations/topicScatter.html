<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Scatter topics</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>


  <style>
    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      margin: auto;
      position: relative;
      width: 1000px;
    }


    #tooltip {
      position: absolute;
      width: 200px;
      height: auto;
      padding: 10px;
      background-color: white;
      -webkit-border-radius: 10px;
      -moz-border-radius: 10px;
      border-radius: 10px;
      -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
      -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
      box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
      pointer-events: none;
    }

    #tooltip.hidden {
      display: none;
    }

    #tooltip p {
      margin: 0;
      font-family: sans-serif;
      font-size: 12px;
      line-height: 20px;
    }


    #info {
      transform: translate(0px, 50px);
      /* Equal to translateX(10px) */
    }

    #info p {
      padding-left: 60px;
      padding-top: 0px;
      margin: 0;
    }
  </style>

</head>

<body>
  <div id="info" translate="0, 100">
    <p class="titlePiece">Query:
      <strong id="qName"></strong>
    </p>
    <p class="titlePiece">Tweets found:
      <strong id="qFound"></strong>
    </p>
  </div>

  <div id="tooltip" class="hidden">
    <p>
      <strong id="topic"></strong>
    </p>
    <p style="font-size: 10px; line-height: 10px;" id="tweet_words">
      </span>

    </p>
  </div>

  <script>
    var colourScale = d3.scaleLinear()
      .domain(d3.range(6))
      .range(["#FF6600", "#CCFE23", "#3399FF", "#72b48d", "#904a86", "#a613fe"]);

    var queries = [];
    var currentQuery = 0; //start happy

    d3.json("../sTwitter/processedSTwitterData.json").then(function (processedData) {
      var promises = [];
      for (let query in processedData) {
        let text = [];
        for (let tweet in query) {
          text.push(tweet.text);
        }

        queries.push({
          query: query,
          text: text,
          words: [],
          xValues: [],
          yValues: [],
          clusters: []
        });
        promises.push(d3.csv("../sTwitter/svd/" + query + "-docbyword.csv"));
        promises.push(d3.text("../sTwitter/svd/" + query + "-docbydoc.csv"));
      }

      Promise.all(promises).then(function (files) {
        makeChart(files); //files all loaded here
      });

    });

    function makeChart(files) {
      for (let i = 0; i < queries.length; i++) {
        let docbyword = files[i * 2];
        let docbydoc = d3.csvParseRows(files[i * 2 + 1]).map(function (row) {
          return row.map(function (value) {
            return +value; //convert to number
          });
        });

        queries[i].words = docbyword.columns
        queries[i].clusters = docbydoc[docbydoc.length - 1];
        queries[i].xValues = docbydoc[0];
        queries[i].yValues = docbydoc[1];
        //to do first two cols:
        /*queries[i].xValues = [];
        queries[i].yValues = [];

        var j = 0;

        for (var row of docbydoc) {
          if (j < docbydoc.length - 1) {
            queries[i].xValues.push(row[0]);
            queries[i].yValues.push(row[1]);
            j++;
          }
        } */

      }
      generateChart(); //actually generate chart
    }

    function generateChart() {

      var w = 600;
      var h = 400;

      var padding = 60;

      var xScale = d3.scaleLinear()
        // .domain([d3.min(queries[currentQuery].xValues), d3.max(queries[currentQuery].xValues)])
        .domain([-1, 1])
        .range([padding, w - padding]);

      var yScale = d3.scaleLinear()
        //.domain([d3.min(queries[currentQuery].yValues), d3.max(queries[currentQuery].yValues)])
        .domain([-1, 1])
        .range([h - padding, padding]);

      var yAxis = d3.axisLeft(yScale);
      var xAxis = d3.axisBottom(xScale);

      d3.select("#qName").text("\'" + queries[currentQuery].query + "\'");
      d3.select("#qFound").text(queries[currentQuery].xValues.length);

      var svg = d3.select("body")
        .append("svg")
        .attr("width", w)
        .attr("height", h);

      svg.selectAll("circle")
        .data(queries[currentQuery].xValues)
        .enter()
        .append("circle")
        .attr("cx", function (d, i) {
          return xScale(queries[currentQuery].xValues[i]);
        })
        .attr("cy", function (d, i) {
          return yScale(queries[currentQuery].yValues[i]);
        })
        .attr("r", function (d) {
          return 2;
        })
        .attr("fill", function (d, i) {
          return colourScale(queries[currentQuery].clusters[i]);
        }).on("mouseover", function (d, i) {
          hoverMethod(d, i, d3.select(this));
        }).on("mouseout", function (d) {
          d3.select("#tooltip").classed("hidden", true);
        });

      svg.append("g")
        .attr("class", "leftAxis")
        .attr("transform", "translate(" + padding + ",0)")
        .call(yAxis);

      svg.append("g")
        .attr("class", "bottomAxis")
        .attr("transform", "translate(0, " + (h - padding) + ")")
        .call(xAxis);

      svg.on("click", function () {
        currentQuery = currentQuery + 1;
        currentQuery = currentQuery % queries.length;
        let circles = svg.selectAll("circle")
          .data(queries[currentQuery].xValues);

        circles.exit()
          .remove();

        circles.enter()
          .append("circle")
          .attr("cx", function (d, i) {
            return xScale(queries[currentQuery].xValues[i]);
          })
          .attr("cy", function (d, i) {
            return yScale(queries[currentQuery].yValues[i]);
          })
          .attr("r", function (d) {
            return 2;
          })
          .attr("fill", function (d, i) {
            return colourScale(queries[currentQuery].clusters[i]);
          }).on("mouseover", function (d, i) {
            hoverMethod(d, i, d3.select(this));
          }).on("mouseout", function (d) {
            d3.select("#tooltip").classed("hidden", true);
          })
          .merge(circles)
          .attr("cx", function (d, i) {
            return xScale(queries[currentQuery].xValues[i]);
          })
          .attr("cy", function (d, i) {
            return yScale(queries[currentQuery].yValues[i]);
          })
          .attr("r", function (d) {
            return 2;
          })
          .attr("fill", function (d, i) {
            return colourScale(queries[currentQuery].clusters[i]);
          });

        d3.select("#qName").text("\'" + queries[currentQuery].query + "\'");
        d3.select("#qFound").text(queries[currentQuery].xValues.length);
      });
    }

    function hoverMethod(d, i, me) {
      var xPosition = parseFloat(me.attr("cx"));
      var yPosition = parseFloat(me.attr("cy"));

      d3.select("#tooltip")
        .style("left", xPosition + "px")
        .style("top", yPosition + "px");
      d3.select("#topic")
        .text(queries[currentQuery].clusters[i]);
      d3.select("#tweet_words")
        .text(queries[currentQuery].words[i]);

      d3.select("#tooltip").classed("hidden", false);
    }
  </script>
</body>

</html>